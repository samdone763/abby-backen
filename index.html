<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Abby Cake and Bites</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:#fdf6ee;color:#2c1810}
nav{background:white;padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #f5d6c8;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(107,63,42,0.06)}
.nav-brand{display:flex;align-items:center;gap:8px;font-family:'Playfair Display',serif;font-size:17px;color:#6b3f2a;font-weight:700}
.nav-links{display:flex;gap:4px}
.nav-btn{padding:7px 14px;border-radius:20px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;background:transparent;color:#6b3f2a;transition:all 0.2s}
.nav-btn:hover{background:#f5d6c8}
.nav-btn.active{background:#c97d6e;color:white}
.status-pill{font-size:11px;padding:4px 10px;border-radius:12px;font-weight:600}
.status-open{background:#d4edda;color:#155724}
.status-closed{background:#f8d7da;color:#721c24}
.page{display:none}
.page.active{display:block}
/* HERO */
.hero{background:linear-gradient(150deg,#fdf0e6,#f9e2d2,#f5d6c8);padding:70px 24px 50px;text-align:center;position:relative}
.hero-badge{display:inline-block;background:rgba(201,125,110,0.12);color:#c97d6e;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:500;margin-bottom:18px;border:1px solid rgba(201,125,110,0.2)}
.hero h1{font-family:'Playfair Display',serif;font-size:clamp(32px,8vw,60px);color:#6b3f2a;line-height:1.1;margin-bottom:14px}
.hero h1 em{font-style:italic;color:#c97d6e}
.hero p{font-size:16px;color:#8a6050;max-width:440px;margin:0 auto 28px;line-height:1.6}
.hero-ctas{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.btn-primary{background:linear-gradient(135deg,#c97d6e,#b56e60);color:white;padding:13px 26px;border-radius:30px;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.2s;box-shadow:0 4px 18px rgba(201,125,110,0.35)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(201,125,110,0.45)}
.btn-secondary{background:white;color:#c97d6e;padding:13px 26px;border-radius:30px;border:2px solid #e8a598;font-size:15px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.2s}
.btn-secondary:hover{background:#f5d6c8}
/* CONTAINER */
.container{max-width:860px;margin:0 auto;padding:36px 20px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin-bottom:40px}
.info-card{background:white;border-radius:14px;padding:18px;border:1px solid rgba(232,165,152,0.2);box-shadow:0 2px 12px rgba(107,63,42,0.04)}
.info-icon{font-size:22px;margin-bottom:8px}
.info-label{font-size:11px;font-weight:600;color:#e8a598;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:3px}
.info-value{font-size:14px;color:#2c1810;font-weight:500;line-height:1.5}
.section-title{font-family:'Playfair Display',serif;font-size:clamp(22px,4vw,32px);color:#6b3f2a;margin-bottom:8px}
.section-sub{color:#8a6050;font-size:14px;margin-bottom:24px}
/* MENU */
.menu-cat-title{font-family:'Playfair Display',serif;font-size:20px;color:#6b3f2a;margin-bottom:14px;display:flex;align-items:center;gap:8px;padding-bottom:10px;border-bottom:2px solid #f5d6c8}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;margin-bottom:32px}
.menu-card{background:white;border-radius:12px;padding:16px;border:1px solid rgba(232,165,152,0.2);cursor:pointer;transition:all 0.2s}
.menu-card:hover{border-color:#e8a598;box-shadow:0 4px 14px rgba(201,125,110,0.12);transform:translateY(-2px)}
.menu-card-name{font-weight:600;font-size:14px;color:#2c1810;margin-bottom:3px}
.menu-card-desc{font-size:12px;color:#9a7060;margin-bottom:7px;line-height:1.4}
.menu-card-price{font-size:12px;font-weight:700;color:#c97d6e}
/* HOURS */
.hours-card{background:white;border-radius:14px;padding:20px;border:1px solid rgba(232,165,152,0.2)}
.hours-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid #f5ede8;font-size:14px}
.hours-row:last-child{border-bottom:none}
.hours-day{font-weight:500;color:#2c1810}
.hours-time{color:#8a6050}
.hours-closed{color:#d4a0a0;font-style:italic}
.hours-today{background:#fff8f6;border-radius:8px;padding:9px 12px;margin-bottom:2px}
/* CHAT */
.chat-wrapper{max-width:660px;margin:0 auto}
.chat-box{background:white;border-radius:22px;border:1px solid rgba(232,165,152,0.3);box-shadow:0 4px 28px rgba(107,63,42,0.08);overflow:hidden;display:flex;flex-direction:column;height:560px}
.chat-header{background:linear-gradient(135deg,#c97d6e,#b56e60);padding:16px 18px;display:flex;align-items:center;gap:10px;color:white}
.chat-avatar{width:42px;height:42px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.chat-header h3{font-size:15px;font-weight:600}
.chat-header p{font-size:12px;opacity:0.85}
.online-dot{width:7px;height:7px;background:#7fff7f;border-radius:50%;display:inline-block;margin-right:4px}
.chat-msgs{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:10px;background:#fdf9f7}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:#f5d6c8;border-radius:2px}
.msg{max-width:80%;animation:fadeUp 0.3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.user{align-self:flex-end}
.msg.assistant{align-self:flex-start}
.msg-bubble{padding:11px 15px;border-radius:17px;font-size:14px;line-height:1.6;white-space:pre-wrap}
.msg.user .msg-bubble{background:linear-gradient(135deg,#c97d6e,#b56e60);color:white;border-bottom-right-radius:4px}
.msg.assistant .msg-bubble{background:white;color:#2c1810;border:1px solid rgba(232,165,152,0.25);border-bottom-left-radius:4px;box-shadow:0 2px 6px rgba(107,63,42,0.06)}
.msg-time{font-size:10px;color:#ccc;margin-top:3px;padding:0 3px}
.msg.user .msg-time{text-align:right}
.typing{display:flex;gap:4px;align-items:center;padding:12px 15px}
.typing span{width:6px;height:6px;background:#e8a598;border-radius:50%;animation:bounce 1.2s infinite}
.typing span:nth-child(2){animation-delay:0.2s}
.typing span:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.quick-btns{display:flex;flex-wrap:wrap;gap:7px;padding:0 18px 12px;background:#fdf9f7}
.quick-btn{padding:6px 13px;background:white;border:1.5px solid #f5d6c8;border-radius:14px;font-size:12px;color:#c97d6e;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500;transition:all 0.15s}
.quick-btn:hover{background:#f5d6c8}
.chat-input-row{padding:12px 14px;border-top:1px solid rgba(232,165,152,0.2);background:white;display:flex;gap:8px;align-items:flex-end}
.chat-input{flex:1;border:1.5px solid #f5d6c8;border-radius:18px;padding:9px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:#2c1810;outline:none;resize:none;max-height:90px;transition:border-color 0.2s;background:#fdf9f7}
.chat-input:focus{border-color:#c97d6e}
.send-btn{width:40px;height:40px;background:linear-gradient(135deg,#c97d6e,#b56e60);border:none;border-radius:50%;color:white;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
.send-btn:hover{transform:scale(1.08)}
.send-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
/* ORDER SUCCESS */
.order-success{background:white;border-radius:18px;padding:28px;text-align:center;border:2px solid rgba(168,184,154,0.4);box-shadow:0 4px 20px rgba(107,63,42,0.08)}
.order-success-icon{font-size:48px;margin-bottom:14px}
.order-success h3{font-family:'Playfair Display',serif;font-size:22px;color:#6b3f2a;margin-bottom:8px}
.order-details{background:#fdf9f7;border-radius:10px;padding:14px;margin:18px 0;text-align:left;font-size:13px}
.detail-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0e8e4}
.detail-row:last-child{border-bottom:none}
.detail-key{color:#9a7060;font-weight:500}
.detail-val{font-weight:600;color:#6b3f2a}
/* ADMIN */
.admin-login{max-width:340px;margin:50px auto;background:white;border-radius:18px;padding:36px 28px;box-shadow:0 4px 28px rgba(107,63,42,0.1);text-align:center}
.admin-login h2{font-family:'Playfair Display',serif;font-size:24px;color:#6b3f2a;margin-bottom:4px}
.admin-login p{color:#9a7060;font-size:13px;margin-bottom:24px}
.form-field{margin-bottom:14px;text-align:left}
.form-field label{display:block;font-size:12px;font-weight:600;color:#6b3f2a;margin-bottom:5px}
.form-input{width:100%;padding:10px 13px;border:1.5px solid #f5d6c8;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:14px;color:#2c1810;outline:none;transition:border-color 0.2s}
.form-input:focus{border-color:#c97d6e}
.admin-panel{max-width:860px;margin:0 auto;padding:28px 20px}
.admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:10px}
.admin-header h2{font-family:'Playfair Display',serif;font-size:26px;color:#6b3f2a}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
.stat-card{background:white;border-radius:12px;padding:16px;border:1px solid rgba(232,165,152,0.2)}
.stat-val{font-size:26px;font-weight:700;color:#c97d6e;font-family:'Playfair Display',serif}
.stat-label{font-size:11px;color:#9a7060;margin-top:3px;font-weight:500}
.orders-table{background:white;border-radius:14px;overflow:hidden;border:1px solid rgba(232,165,152,0.2)}
.table-header{background:linear-gradient(135deg,#f5d6c8,#f9e2d2);padding:12px 18px;display:grid;grid-template-columns:80px 1fr 1fr 90px;gap:10px;font-size:11px;font-weight:700;color:#6b3f2a;text-transform:uppercase;letter-spacing:0.05em}
.order-row{padding:12px 18px;display:grid;grid-template-columns:80px 1fr 1fr 90px;gap:10px;border-bottom:1px solid #f5ede8;font-size:13px;align-items:center}
.order-row:last-child{border-bottom:none}
.order-row:hover{background:#fdf9f7}
.badge{padding:3px 8px;border-radius:8px;font-size:11px;font-weight:600;display:inline-block}
.badge-pending{background:#fff3cd;color:#856404}
.badge-confirmed{background:#d4edda;color:#155724}
.error-msg{background:#fff0f0;color:#c0392b;padding:9px 12px;border-radius:8px;font-size:13px;margin-bottom:12px;border:1px solid #ffd5d5}
/* FLOATING BTNS */
.wa-float{position:fixed;bottom:24px;right:24px;width:52px;height:52px;background:#25D366;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;box-shadow:0 4px 14px rgba(37,211,102,0.4);z-index:999;text-decoration:none;transition:all 0.2s}
.wa-float:hover{transform:scale(1.1)}
footer{background:#2c1810;color:rgba(255,255,255,0.65);text-align:center;padding:28px 20px;font-size:13px;margin-top:50px}
footer strong{color:#e8a598}
@media(max-width:500px){
  .table-header,.order-row{grid-template-columns:60px 1fr 1fr}
  .table-header span:last-child,.order-row span:last-child{display:none}
  .nav-btn span{display:none}
}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-brand">üéÇ Abby Cake & Bites</div>
  <div class="nav-links">
    <button class="nav-btn active" onclick="showPage('home')">üè† <span>Home</span></button>
    <button class="nav-btn" onclick="showPage('menu')">üéÇ <span>Menu</span></button>
    <button class="nav-btn" onclick="showPage('chat')">üí¨ <span>Order</span></button>
    <button class="nav-btn" onclick="showPage('admin')">üîê <span>Admin</span></button>
  </div>
  <span id="statusPill" class="status-pill status-closed">Closed</span>
</nav>

<!-- HOME PAGE -->
<div id="page-home" class="page active">
  <div class="hero">
    <div class="hero-badge">‚ú® Handcrafted Cakes & Bites ¬∑ Himo, Tanzania</div>
    <h1>Where Every Bite is<br/><em>Pure Delight</em></h1>
    <p>Custom cakes, pastries & sweets baked fresh daily with love for every occasion.</p>
    <div class="hero-ctas">
      <button class="btn-primary" onclick="showPage('chat')">üéÇ Order via AI Chat</button>
      <button class="btn-secondary" onclick="showPage('menu')">View Menu</button>
    </div>
  </div>
  <div class="container">
    <div class="info-grid">
      <div class="info-card"><div class="info-icon">üìç</div><div class="info-label">Location</div><div class="info-value">Njiapanda, Himo<br/>Tanzania</div></div>
      <div class="info-card"><div class="info-icon">üìû</div><div class="info-label">Phone / WhatsApp</div><div class="info-value">0620 767 919</div></div>
      <div class="info-card"><div class="info-icon">üïê</div><div class="info-label">Today's Hours</div><div class="info-value" id="todayHours">Loading...</div></div>
      <div class="info-card"><div class="info-icon">üöó</div><div class="info-label">Delivery</div><div class="info-value">Available in Himo<br/>TZS 3,000‚Äì8,000</div></div>
    </div>
    <h2 class="section-title">Opening Hours</h2>
    <p class="section-sub">We're here to sweeten your week</p>
    <div class="hours-card" id="hoursCard"></div>
  </div>
  <footer><strong>Abby Cake and Bites</strong> ¬∑ Njiapanda, Himo ¬∑ 0620 767 919 ¬∑ Made with üéÇ</footer>
</div>

<!-- MENU PAGE -->
<div id="page-menu" class="page">
  <div class="container">
    <h2 class="section-title">Our Menu</h2>
    <p class="section-sub">Fresh, handcrafted treats for every occasion ‚Äî tap any item to order!</p>
    <div class="menu-cat-title">üéÇ Custom Cakes</div>
    <div class="menu-grid">
      <div class="menu-card" onclick="orderItem('Birthday Cake')"><div class="menu-card-name">Birthday Cake</div><div class="menu-card-desc">Personalized & themed to your wishes</div><div class="menu-card-price">TZS 25,000 ‚Äì 80,000</div></div>
      <div class="menu-card" onclick="orderItem('Wedding Cake')"><div class="menu-card-name">Wedding Cake</div><div class="menu-card-desc">Elegant multi-tier masterpieces</div><div class="menu-card-price">TZS 80,000 ‚Äì 300,000</div></div>
      <div class="menu-card" onclick="orderItem('Anniversary Cake')"><div class="menu-card-name">Anniversary Cake</div><div class="menu-card-desc">Romantic designs with messages</div><div class="menu-card-price">TZS 30,000 ‚Äì 75,000</div></div>
      <div class="menu-card" onclick="orderItem('Baby Shower Cake')"><div class="menu-card-name">Baby Shower Cake</div><div class="menu-card-desc">Adorable pastel creations</div><div class="menu-card-price">TZS 28,000 ‚Äì 60,000</div></div>
    </div>
    <div class="menu-cat-title">üç™ Bites & Pastries</div>
    <div class="menu-grid">
      <div class="menu-card" onclick="orderItem('Cupcakes')"><div class="menu-card-name">Cupcakes</div><div class="menu-card-desc">Mini decorated in any flavor</div><div class="menu-card-price">TZS 12,000 ‚Äì 22,000</div></div>
      <div class="menu-card" onclick="orderItem('Cookies')"><div class="menu-card-name">Cookies</div><div class="menu-card-desc">Freshly baked butter & choco chip</div><div class="menu-card-price">TZS 8,000 ‚Äì 15,000</div></div>
      <div class="menu-card" onclick="orderItem('Brownies')"><div class="menu-card-name">Brownies</div><div class="menu-card-desc">Fudgy dark chocolate brownies</div><div class="menu-card-price">TZS 10,000 ‚Äì 20,000</div></div>
      <div class="menu-card" onclick="orderItem('Cake Pops')"><div class="menu-card-name">Cake Pops</div><div class="menu-card-desc">Fun bite-sized cake balls on a stick</div><div class="menu-card-price">TZS 12,000 ‚Äì 22,000</div></div>
      <div class="menu-card" onclick="orderItem('Doughnuts')"><div class="menu-card-name">Doughnuts</div><div class="menu-card-desc">Glazed, sprinkled or filled</div><div class="menu-card-price">TZS 9,000 ‚Äì 17,000</div></div>
      <div class="menu-card" onclick="orderItem('Muffins')"><div class="menu-card-name">Muffins</div><div class="menu-card-desc">Blueberry, banana or choco-chip</div><div class="menu-card-price">TZS 8,000 ‚Äì 15,000</div></div>
    </div>
    <div style="text-align:center;margin-top:16px">
      <button class="btn-primary" onclick="showPage('chat')">Place Order via AI Chat üéÇ</button>
    </div>
  </div>
</div>

<!-- CHAT PAGE -->
<div id="page-chat" class="page">
  <div class="container">
    <h2 class="section-title">Chat with Abby</h2>
    <p class="section-sub" id="chatStatusMsg">Ask anything or place your order</p>
    <div class="chat-wrapper">
      <div id="orderSuccess" style="display:none"></div>
      <div id="chatBox" class="chat-box">
        <div class="chat-header">
          <div class="chat-avatar">üéÇ</div>
          <div>
            <h3>Abby ¬∑ AI Assistant</h3>
            <p><span class="online-dot"></span>Connected ¬∑ Orders saved & SMS sent</p>
          </div>
        </div>
        <div class="chat-msgs" id="chatMsgs"></div>
        <div class="quick-btns" id="quickBtns">
          <button class="quick-btn" onclick="sendMsg('What cakes do you have?')">What cakes?</button>
          <button class="quick-btn" onclick="sendMsg('Are you open now?')">Are you open?</button>
          <button class="quick-btn" onclick="sendMsg('I want to place an order')">Order now</button>
          <button class="quick-btn" onclick="sendMsg('What are your prices?')">Prices?</button>
          <button class="quick-btn" onclick="sendMsg('Do you deliver?')">Delivery?</button>
        </div>
        <div class="chat-input-row">
          <textarea class="chat-input" id="chatInput" placeholder="Type your message..." rows="1" onkeydown="handleKey(event)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendFromInput()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page">
  <div id="adminLogin">
    <div class="container">
      <div class="admin-login">
        <div style="font-size:38px;margin-bottom:10px">üîê</div>
        <h2>Admin Login</h2>
        <p>Abby Cake & Bites ¬∑ Dashboard</p>
        <div id="loginErr"></div>
        <div class="form-field"><label>Username</label><input class="form-input" id="adminUser" placeholder="abby_admin"/></div>
        <div class="form-field"><label>Password</label><input class="form-input" type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
        <button class="btn-primary" style="width:100%" onclick="doLogin()" id="loginBtn">Login ‚Üí</button>
      </div>
    </div>
  </div>
  <div id="adminPanel" style="display:none">
    <div class="admin-panel">
      <div class="admin-header">
        <h2>üìä Orders Dashboard</h2>
        <button class="btn-secondary" style="font-size:13px;padding:8px 16px" onclick="doLogout()">Logout</button>
      </div>
      <div class="stats-grid" id="statsGrid"></div>
      <div id="ordersContent"></div>
    </div>
  </div>
</div>

<!-- WHATSAPP FLOAT -->
<a class="wa-float" href="https://wa.me/255620767919" target="_blank">üí¨</a>

<script>
const API = 'https://abby-backend.onrender.com';

// ‚îÄ‚îÄ HOURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HOURS = {
  0: null,
  1: [7,19], 2: [7,19], 3: [7,19], 4: [7,19],
  5: [7,20], 6: [7,20]
};
const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

function isOpen() {
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours();
  const rule = HOURS[day];
  if (!rule) return false;
  return h >= rule[0] && h < rule[1];
}

function getHoursText(day) {
  const rule = HOURS[day];
  if (!rule) return 'Closed';
  return rule[0]+':00 AM ‚Äì '+( rule[1] > 12 ? (rule[1]-12)+':00 PM' : rule[1]+':00 PM');
}

function initHours() {
  const today = new Date().getDay();
  const open = isOpen();
  // status pill
  const pill = document.getElementById('statusPill');
  pill.textContent = open ? 'üü¢ Open Now' : 'üî¥ Closed';
  pill.className = 'status-pill ' + (open ? 'status-open' : 'status-closed');
  // today card
  document.getElementById('todayHours').innerHTML = '<strong>'+DAYS[today]+'</strong><br/>'+getHoursText(today)+(open?'<br/><span style="color:#2d8a4e;font-size:12px;font-weight:600">‚óè Open Now</span>':'<br/><span style="color:#c97d6e;font-size:12px;font-weight:600">‚óè Currently Closed</span>');
  // hours list
  let html = '';
  for (let i = 1; i <= 7; i++) {
    const d = i % 7;
    const isToday = d === today;
    html += '<div class="hours-row'+(isToday?' hours-today':'')+'"><span class="hours-day">'+(isToday?'<strong>':'')+DAYS[d]+(isToday?' (Today)</strong>':'')+'</span>';
    const t = getHoursText(d);
    html += t === 'Closed' ? '<span class="hours-closed">Closed</span>' : '<span class="hours-time">'+t+'</span>';
    html += '</div>';
  }
  document.getElementById('hoursCard').innerHTML = html;
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-btn')[['home','menu','chat','admin'].indexOf(name)].classList.add('active');
  if (name === 'chat' && chatHistory.length === 0) initChat();
}

function orderItem(item) {
  showPage('chat');
  if (chatHistory.length === 0) initChat();
  setTimeout(() => sendMsg('I want to order ' + item), 400);
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chatHistory = [];
let chatLoading = false;

function initChat() {
  const open = isOpen();
  let greeting;
  if (open) {
    greeting = "Hi there! üéÇ I'm Abby, your virtual assistant for Abby Cake and Bites!\n\nWe're currently OPEN and ready to take your order! I can help you with our menu, prices, or place an order for you right now.\n\nWhat can I do for you today?";
  } else {
    const today = new Date().getDay();
    const tomorrow = (today + 1) % 7;
    const nextOpen = HOURS[tomorrow] ? 'tomorrow at ' + HOURS[tomorrow][0] + ':00 AM' : 'Monday at 7:00 AM';
    greeting = "Hi there! üéÇ I'm Abby from Abby Cake and Bites!\n\nWe're currently CLOSED right now, but we'll be open " + nextOpen + ".\n\nYou're welcome to browse our menu or pre-order and we'll confirm when we open! How can I help you?";
  }
  addMsg('assistant', greeting);
  chatHistory = [{role:'assistant', content: greeting}];
}

function addMsg(role, text) {
  const msgs = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  const now = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  div.innerHTML = '<div class="msg-bubble">'+escHtml(text)+'</div><div class="msg-time">'+now+'</div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  if (chatHistory.length > 2) document.getElementById('quickBtns').style.display = 'none';
}

function showTyping() {
  const msgs = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'msg assistant';
  div.id = 'typingIndicator';
  div.innerHTML = '<div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typingIndicator');
  if (t) t.remove();
}

function escHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br/>');
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendFromInput(); }
}

function sendFromInput() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (text) { input.value = ''; sendMsg(text); }
}

async function sendMsg(text) {
  if (chatLoading || !text.trim()) return;
  if (chatHistory.length === 0) initChat();
  addMsg('user', text);
  chatHistory.push({role:'user', content: text});
  chatLoading = true;
  document.getElementById('sendBtn').disabled = true;
  showTyping();

  try {
    const res = await fetch(API + '/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({messages: chatHistory})
    });
    const data = await res.json();
    removeTyping();

    if (!data.success) throw new Error(data.message);
    const reply = data.reply;

    // Check for order JSON
    const match = reply.match(/ORDER_JSON:(\{.*?\})/s);
    if (match) {
      try {
        const parsed = JSON.parse(match[1]);
        const orderRes = await fetch(API + '/api/orders', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            customer: {name: parsed.customerName, phone: parsed.customerPhone},
            item: {type: parsed.itemType, size: parsed.size, flavor: parsed.flavor, quantity: parsed.quantity},
            delivery: {type: (parsed.deliveryType||'').toLowerCase().includes('delivery')?'delivery':'pickup', address: parsed.address},
            dateNeeded: parsed.dateNeeded,
            notes: parsed.notes || ''
          })
        });
        const orderData = await orderRes.json();
        const cleanReply = reply.replace(/ORDER_JSON:\{.*?\}/s,'').trim();
        if (cleanReply) addMsg('assistant', cleanReply);
        if (orderData.success) showOrderSuccess(orderData.order);
      } catch(e) {
        addMsg('assistant', reply.replace(/ORDER_JSON:\{.*?\}/s,'').trim() || 'Your order details have been noted! Please call 0620 767 919 to confirm.');
      }
    } else {
      addMsg('assistant', reply);
      chatHistory.push({role:'assistant', content: reply});
    }
  } catch(e) {
    removeTyping();
    const r = smartReply(text);
    if(r) addMsg('assistant', r);
  }
  chatLoading = false;
  document.getElementById('sendBtn').disabled = false;
}


let orderData = {};
let orderStep = null;
const MENU_TEXT = "BITES/VITAFUNWA:\n- Cupcakes with Buttercream: TZS 10,000\n- Cookies Package: TZS 5,000\n- Plain Cupcakes 6pcs: TZS 3,000\n- Chapati Package: TZS 10,000\n- Donut Package 6pcs: TZS 10,000\n- Mandazi 10pcs: TZS 3,000\n- Meat Sambusa 8pcs: TZS 10,000\n\nCAKES:\n- Plain Cake: TZS 10,000\n- Bento Cake: TZS 15,000\n- Birthday Cake 700g: TZS 25,000\n- Chocolate Cake 1kg: TZS 45,000\n- Flavour Cake 1kg: TZS 35,000\n- Fruits Cake 1kg: TZS 55,000\n- Red Velvet Cake 1kg: TZS 40,000";

function smartReply(text) {
  const t = text.toLowerCase();
  if(orderStep==='item'){orderData.item=text;orderStep='name';return 'Great choice: '+text+'! What is your full name?';}
  if(orderStep==='name'){orderData.name=text;orderStep='phone';return 'Nice to meet you '+text+'! What is your phone number?';}
  if(orderStep==='phone'){orderData.phone=text;orderStep='delivery';return 'Got it! Pickup or Delivery? (Delivery in Himo: TZS 3,000-8,000)';}
  if(orderStep==='delivery'){orderData.delivery=text;orderStep='date';return 'When do you need your order?';}
  if(orderStep==='date'){orderData.date=text;orderStep='confirm';return 'Confirm your order:\nItem: '+orderData.item+'\nName: '+orderData.name+'\nPhone: '+orderData.phone+'\nDelivery: '+orderData.delivery+'\nDate: '+orderData.date+'\n\nType YES to confirm or NO to cancel.';}
  if(orderStep==='confirm'){
    if(t.includes('yes')||t.includes('ndio')){submitLocalOrder();return null;}
    else{orderStep=null;orderData={};return 'Order cancelled. Type order to try again.';}
  }
  if(t.includes('hi')||t.includes('hello')||t.includes('hujambo')||t.includes('habari')){return 'Hujambo! Welcome to Abby Cake and Bites! How can I help?\n\nType: menu, order, hours, or delivery';}
  if(t.includes('menu')||t.includes('price')||t.includes('bei')||t.includes('cake')||t.includes('vitafunwa')||t.includes('how much')){return MENU_TEXT;}
  if(t.includes('order')||t.includes('buy')||t.includes('nataka')||t.includes('want')){orderStep='item';orderData={};return 'What would you like to order?\n\n'+MENU_TEXT+'\n\nType the item name!';}
  if(t.includes('open')||t.includes('hours')||t.includes('time')){var op=isOpen();return 'Opening Hours:\nMon-Thu: 7AM-7PM\nFri-Sat: 7AM-8PM\nSunday: Closed\n\nNow: '+(op?'OPEN':'CLOSED');}
  if(t.includes('deliver')||t.includes('location')||t.includes('where')){return 'We are at Njiapanda, Himo, Tanzania\nDelivery in Himo: TZS 3,000-8,000\nCall: 0620 767 919';}
  if(t.includes('thank')||t.includes('asante')){return 'Asante sana! We love serving you!';}
  return 'I can help with:\n- menu: see prices\n- order: place an order\n- hours: opening times\n- delivery: delivery info\n\nOr call: 0620 767 919';
}

async function submitLocalOrder(){
  try{await fetch(API+'/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customer:{name:orderData.name,phone:orderData.phone},item:{type:orderData.item,size:'',flavor:'',quantity:1},delivery:{type:orderData.delivery.toLowerCase().includes('delivery')?'delivery':'pickup',address:''},dateNeeded:orderData.date,notes:''})});}catch(e){}
  var msg='New Order!%0AName: '+orderData.name+'%0APhone: '+orderData.phone+'%0AItem: '+orderData.item+'%0ADelivery: '+orderData.delivery+'%0ADate: '+orderData.date;
  var waUrl='https://wa.me/255620767919?text='+msg;
  var d=document.createElement('div');d.className='msg assistant';
  var b=document.createElement('div');b.className='msg-bubble';
  b.innerHTML='Order confirmed! Thank you <b>'+orderData.name+'</b>!<br/><br/><a href="'+waUrl+'" target="_blank" style="background:#25D366;color:white;padding:10px 20px;border-radius:20px;text-decoration:none;display:inline-block;font-weight:600">Send Order on WhatsApp</a><br/><br/>We will call you on '+orderData.phone+' to confirm.';
  d.appendChild(b);
  document.getElementById('chatMsgs').appendChild(d);
  document.getElementById('chatMsgs').scrollTop=99999;
  orderStep=null;orderData={};chatLoading=false;
  document.getElementById('sendBtn').disabled=false;
},body:JSON.stringify({customer:{name:orderData.name,phone:orderData.phone},item:{type:orderData.item,size:'',flavor:'',quantity:1},delivery:{type:orderData.delivery.toLowerCase().includes('delivery')?'delivery':'pickup',address:''},dateNeeded:orderData.date,notes:''})});
  }catch(e){}
  removeTyping();
  var msg = 'New Order from Abby Website!\nName: '+orderData.name+'\nPhone: '+orderData.phone+'\nItem: '+orderData.item+'\nDelivery: '+orderData.delivery+'\nDate: '+orderData.date;
  var waUrl = 'https://wa.me/255620767919?text='+encodeURIComponent(msg);
  addMsg('assistant','Order confirmed! Thank you '+orderData.name+'!\n\nPlease tap the button below to notify the bakery on WhatsApp:\n\n<a href=\"'+waUrl+'\" target=\"_blank\" style=\"background:#25D366;color:white;padding:10px 20px;border-radius:20px;text-decoration:none;display:inline-block;margin-top:8px;font-weight:600\">Send Order on WhatsApp</a>\n\nWe will call you on '+orderData.phone+' to confirm.');
  orderStep=null;orderData={};
  chatLoading=false;
  document.getElementById('sendBtn').disabled=false;
}

async function sendMsg(text) {
  if(chatLoading||!text.trim()) return;
  if(chatHistory.length===0) initChat();
  addMsg('user',text);
  chatLoading=true;
  document.getElementById('sendBtn').disabled=true;
  showTyping();
  await new Promise(r=>setTimeout(r,700));
  removeTyping();
  const reply=smartReply(text);
  if(reply){
  if(reply.includes('<a href')){
    const div=document.createElement('div');
    div.className='msg assistant';
    const bubble=document.createElement('div');
    bubble.className='msg-bubble';
    bubble.innerHTML=reply.replace(/\n/g,'<br/>');
    div.appendChild(bubble);
    document.getElementById('chatMsgs').appendChild(div);
    document.getElementById('chatMsgs').scrollTop=99999;
  } else {
    addMsg('assistant',reply);
  }
}
  if(chatHistory.length>2) document.getElementById('quickBtns').style.display='none';
  chatLoading=false;
  document.getElementById('sendBtn').disabled=false;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initHours();
</script>
</body>
</html>
< Mon Feb 23 13:16:06 EAT 2026 -->
